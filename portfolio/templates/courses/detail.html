{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} – {{ block.super }}{% endblock %}

{% block meta_description %}{{ course.description|truncatewords:30 }}{% endblock %}

{% block extra_head %}
<style>
    /* ===== CSS Variables ===== */
    :root {
        --primary: #0d6efd;
        --primary-dark: #0b5ed7;
        --secondary: #6c757d;
        --success: #28a745;
        --warning: #ffc107;
        --light: #f8f9fa;
        --dark: #212529;
        --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
        --card-shadow-hover: 0 20px 40px rgba(0,0,0,0.12);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* ===== Course Header ===== */
    .course-header {
        background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
        margin-top: -1rem;
    }
    .course-header .breadcrumb {
        background: transparent;
        padding: 0;
    }
    .course-header .breadcrumb-item a {
        color: rgba(255,255,255,0.85);
        text-decoration: none;
        transition: color 0.2s;
    }
    .course-header .breadcrumb-item a:hover {
        color: white;
        text-decoration: underline;
    }
    .course-header .breadcrumb-item.active {
        color: white;
        font-weight: 500;
    }
    .course-header__code {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        padding: 0.3rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 1rem;
    }
    .course-header__title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .course-header__description {
        font-size: 1.1rem;
        opacity: 0.95;
        margin-bottom: 1.5rem;
    }
    .course-header__badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .badge-custom {
        padding: 0.5rem 1.2rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.875rem;
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        color: white;
    }
    .course-header__meta {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        align-items: center;
        font-size: 1rem;
    }
    .course-header__meta i {
        margin-right: 0.5rem;
    }

    /* ===== Enrollment Card ===== */
    .enroll-card {
        background: white;
        border-radius: 24px;
        box-shadow: var(--card-shadow);
        padding: 2rem;
        position: sticky;
        top: 100px;
    }
    .enroll-card__price {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1rem;
    }
    .enroll-card__price.free {
        color: var(--success);
    }
    .btn-enroll {
        display: block;
        width: 100%;
        padding: 1rem;
        border-radius: 50px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        transition: var(--transition);
        margin-bottom: 0.5rem;
    }
    .btn-enroll-primary {
        background: var(--primary);
        color: white;
        border: none;
    }
    .btn-enroll-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(13,110,253,0.3);
    }
    .btn-enroll-success {
        background: var(--success);
        color: white;
    }
    .btn-enroll-success:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40,167,69,0.3);
    }
    .btn-enroll-outline {
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
    }
    .btn-enroll-outline:hover {
        background: var(--primary);
        color: white;
    }

    /* ===== Content Sections ===== */
    .section-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        position: relative;
        padding-bottom: 0.5rem;
    }
    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 4px;
        background: var(--primary);
        border-radius: 2px;
    }

    .card-custom {
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        transition: var(--transition);
    }
    .card-custom:hover {
        box-shadow: var(--card-shadow-hover);
    }

    /* ===== Accordion (Syllabus) ===== */
    .accordion-item {
        border: none;
        margin-bottom: 1rem;
        border-radius: 12px !important;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .accordion-button {
        background: white;
        font-weight: 600;
        padding: 1.2rem 1.5rem;
    }
    .accordion-button:not(.collapsed) {
        background: var(--light);
        color: var(--dark);
        box-shadow: none;
    }
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(13,110,253,0.2);
    }
    .accordion-body {
        background: white;
        padding: 1.5rem;
    }

    /* ===== Instructor Card ===== */
    .instructor-img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary);
    }

    /* ===== Related Cards ===== */
    .related-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        height: 100%;
        transition: var(--transition);
        text-decoration: none;
        color: var(--dark);
        display: block;
    }
    .related-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
        color: var(--dark);
    }
    .related-card__title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .related-card__meta {
        font-size: 0.875rem;
        color: var(--secondary);
    }

    /* ===== Skills ===== */
    .skill-badge {
        background: var(--light);
        color: var(--dark);
        padding: 0.3rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid #e9ecef;
        transition: var(--transition);
    }
    .skill-badge:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* ===== Share Buttons ===== */
    .share-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--light);
        color: var(--dark);
        transition: var(--transition);
        text-decoration: none;
        margin-right: 0.5rem;
    }
    .share-btn:hover {
        background: var(--primary);
        color: white;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
    {# Course Header #}
    <section class="course-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    {# Breadcrumbs #}
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'course_list' %}">Courses</a></li>
                            <li class="breadcrumb-item active" aria-current="page">{{ course.title|truncatechars:30 }}</li>
                        </ol>
                    </nav>

                    {# Course code #}
                    <div class="course-header__code">{{ course.course_code }}</div>

                    {# Title and description #}
                    <h1 class="course-header__title">{{ course.title }}</h1>
                    <p class="course-header__description">{{ course.description }}</p>

                    {# Badges #}
                    <div class="course-header__badges">
                        <span class="badge-custom">
                            <i class="fas fa-signal me-1"></i>{{ course.get_difficulty_display }}
                        </span>
                        <span class="badge-custom">
                            <i class="fas fa-graduation-cap me-1"></i>{{ course.get_level_display }}
                        </span>
                        <span class="badge-custom">
                            <i class="fas fa-clock me-1"></i>{{ course.duration }}
                        </span>
                    </div>

                    {# Meta (instructor, enrolled, rating) #}
                    <div class="course-header__meta">
                        <span><i class="fas fa-user"></i> {{ course.instructor.get_display_name }}</span>
                        <span><i class="fas fa-users"></i> {{ course.enrollment_count }} enrolled</span>
                        <span><i class="fas fa-star text-warning"></i> {{ average_rating|floatformat:1 }} ({{ course.reviews.count }} reviews)</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container py-5">
        <div class="row g-5">
            {# Main Content – left column (8 cols) #}
            <div class="col-lg-8">
                {# About this course #}
                <div class="card-custom">
                    <h2 class="section-title">About this course</h2>
                    <p>{{ course.detailed_description|default:course.description|linebreaks }}</p>
                </div>

                {# What you'll learn #}
                {% if course.learning_outcomes %}
                <div class="card-custom">
                    <h2 class="section-title">What you'll learn</h2>
                    <ul class="list-unstyled row row-cols-1 row-cols-md-2 g-3">
                        {% for outcome in course.learning_outcomes %}
                        <li class="col">
                            <i class="fas fa-check-circle text-success me-2"></i>{{ outcome }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {# Course syllabus #}
                <div class="card-custom">
                    <h2 class="section-title">Course syllabus</h2>
                    <div class="accordion" id="syllabusAccordion">
                        {% for module in modules %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ module.id }}">
                                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                                        type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapse{{ module.id }}" 
                                        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <span>Module {{ module.order }}: {{ module.title }}</span>
                                        <span class="badge bg-primary rounded-pill ms-3">{{ module.lessons.count }} lessons</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ module.id }}" 
                                 class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                                 data-bs-parent="#syllabusAccordion">
                                <div class="accordion-body">
                                    {% if module.description %}
                                    <p class="text-muted small">{{ module.description }}</p>
                                    {% endif %}
                                    <ul class="list-unstyled mb-0">
                                        {% for lesson in module.lessons.all %}
                                        <li class="mb-2">
                                            <i class="fas fa-video me-2 text-primary"></i> {{ lesson.title }}
                                            <span class="text-muted ms-2 small">{{ lesson.duration_minutes }} min</span>
                                        </li>
                                        {% empty %}
                                        <li class="text-muted">No lessons published yet.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">Course modules are being prepared.</p>
                        {% endfor %}
                    </div>
                </div>

                {# Instructor #}
                <div class="card-custom">
                    <h2 class="section-title">Your instructor</h2>
                    <div class="d-flex align-items-center flex-wrap">
                        <div class="me-4 mb-3">
                            {% if course.instructor.profile_picture %}
                            <img src="{{ course.instructor.profile_picture.url }}" 
                                 class="instructor-img" 
                                 alt="{{ course.instructor.get_display_name }}">
                            {% else %}
                            <div class="instructor-img bg-primary text-white d-flex align-items-center justify-content-center">
                                <span class="fs-2">{{ course.instructor.get_display_name|first|upper }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <h4 class="fw-bold mb-1">{{ course.instructor.get_display_name }}</h4>
                            <p class="text-muted small mb-2">{{ course.instructor.title|default:"Instructor" }}</p>
                            <p class="small">{{ course.instructor.bio|default:"Experienced professional in the field."|truncatewords:50 }}</p>
                        </div>
                    </div>
                </div>

                {# ===== Related Content Sections ===== #}
                {% if course.blog_posts.exists %}
                <div class="card-custom">
                    <h2 class="section-title">Related Blog Posts</h2>
                    <div class="row g-3">
                        {% for post in course.blog_posts.all|slice:":3" %}
                        <div class="col-md-4">
                            <a href="{% url 'blog_detail' post.slug %}" class="related-card">
                                <h5 class="related-card__title">{{ post.title|truncatechars:30 }}</h5>
                                <p class="related-card__meta">{{ post.created_at|date:"M d, Y" }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% if course.blog_posts.count > 3 %}
                    <div class="text-end mt-3">
                        <a href="{% url 'blog_list' %}?course={{ course.slug }}" class="btn btn-sm btn-outline-primary rounded-pill">View all {{ course.blog_posts.count }} posts</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if course.notes.exists %}
                <div class="card-custom">
                    <h2 class="section-title">Course Notes</h2>
                    <div class="row g-3">
                        {% for note in course.notes.all|slice:":3" %}
                        <div class="col-md-4">
                            <a href="{% url 'note_detail' note.slug %}" class="related-card">
                                <h5 class="related-card__title">{{ note.title|truncatechars:30 }}</h5>
                                <p class="related-card__meta">{{ note.created_at|date:"M d, Y" }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% if course.notes.count > 3 %}
                    <div class="text-end mt-3">
                        <a href="{% url 'notes_list' %}?course={{ course.slug }}" class="btn btn-sm btn-outline-primary rounded-pill">View all {{ course.notes.count }} notes</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if course.documents.exists %}
                <div class="card-custom">
                    <h2 class="section-title">Documents</h2>
                    <div class="list-group list-group-flush">
                        {% for doc in course.documents.all|slice:":5" %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <i class="fas fa-file-{% if doc.document_type == 'pdf' %}pdf{% elif doc.document_type == 'slides' %}powerpoint{% else %}alt{% endif %} me-2 text-primary"></i>
                                <a href="{% url 'document_detail' doc.slug %}" class="text-decoration-none">{{ doc.title }}</a>
                            </div>
                            <small class="text-muted">{{ doc.file_size|filesizeformat }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% if course.documents.count > 5 %}
                    <div class="text-end mt-3">
                        <a href="{% url 'documents_list' %}?course={{ course.slug }}" class="btn btn-sm btn-outline-primary rounded-pill">View all {{ course.documents.count }} documents</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if course.example_projects.exists %}
                <div class="card-custom">
                    <h2 class="section-title">Example Projects</h2>
                    <div class="row g-3">
                        {% for project in course.example_projects.all|slice:":3" %}
                        <div class="col-md-4">
                            <a href="{% url 'project_detail' project.slug %}" class="related-card">
                                <h5 class="related-card__title">{{ project.title|truncatechars:30 }}</h5>
                                <p class="related-card__meta">{{ project.created_at|date:"M d, Y" }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% if course.example_projects.count > 3 %}
                    <div class="text-end mt-3">
                        <a href="{% url 'projects_list' %}?course={{ course.slug }}" class="btn btn-sm btn-outline-primary rounded-pill">View all {{ course.example_projects.count }} projects</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if course.recommended_books.exists %}
                <div class="card-custom">
                    <h2 class="section-title">Recommended Books</h2>
                    <div class="row g-3">
                        {% for book in course.recommended_books.all|slice:":3" %}
                        <div class="col-md-4">
                            <a href="{% url 'book_detail' book.id %}" class="related-card">
                                <h5 class="related-card__title">{{ book.title|truncatechars:30 }}</h5>
                                <p class="related-card__meta">{{ book.author }}</p>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% if course.recommended_books.count > 3 %}
                    <div class="text-end mt-3">
                        <a href="{% url 'books_list' %}?course={{ course.slug }}" class="btn btn-sm btn-outline-primary rounded-pill">View all {{ course.recommended_books.count }} books</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if course.meetings.exists %}
                <div class="card-custom">
                    <h2 class="section-title">Course Meetings</h2>
                    <div class="list-group list-group-flush">
                        {% for meeting in course.meetings.all|slice:":5" %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <i class="fas fa-video me-2 text-primary"></i>
                                <a href="{% url 'meeting_detail' meeting.slug %}" class="text-decoration-none">{{ meeting.title }}</a>
                                <small class="text-muted ms-2">{{ meeting.date|date:"M d, Y" }} at {{ meeting.start_time|time:"H:i" }}</small>
                            </div>
                            <span class="badge {% if meeting.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ meeting.is_active|yesno:"Upcoming,Past" }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% if course.meetings.count > 5 %}
                    <div class="text-end mt-3">
                        <a href="{% url 'meetings_list' %}?course={{ course.slug }}" class="btn btn-sm btn-outline-primary rounded-pill">View all {{ course.meetings.count }} meetings</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {# Sidebar – right column (4 cols) #}
            <div class="col-lg-4">
                <div class="enroll-card">
                    {# Price #}
                    <div class="enroll-card__price {% if course.is_free %}free{% endif %}">
                        {% if course.is_free %}
                            Free
                        {% else %}
                            ${{ course.price }}
                        {% endif %}
                    </div>

                    {# Enroll / Continue button – safe handling for first_module #}
                    {% if is_enrolled %}
                        {% if first_module %}
                            <a href="{% url 'course_module_detail' course.slug first_module.id %}" 
                               class="btn-enroll btn-enroll-success">
                                <i class="fas fa-play-circle me-2"></i>Continue Learning
                            </a>
                        {% else %}
                            <a href="{% url 'course_detail' course.slug %}" 
                               class="btn-enroll btn-enroll-outline">
                                <i class="fas fa-info-circle me-2"></i>Course Overview
                            </a>
                        {% endif %}
                        <p class="text-muted small text-center mt-2">You are enrolled in this course.</p>
                    {% else %}
                        {% if course.slug %}
                            <form method="post" action="{% url 'enroll_course' course.slug %}">
                                {% csrf_token %}
                                <button type="submit" class="btn-enroll btn-enroll-primary">
                                    <i class="fas fa-graduation-cap me-2"></i>Enroll Now
                                </button>
                            </form>
                        {% else %}
                            <div class="btn-enroll btn-enroll-outline disabled">Not Available</div>
                        {% endif %}
                        {% if not course.is_free %}
                            <p class="text-muted small text-center mt-2">Secure payment via credit card or PayPal</p>
                        {% endif %}
                    {% endif %}

                    <hr class="my-4">

                    {# Course includes #}
                    <h6 class="fw-bold mb-3"><i class="fas fa-list-ul me-2"></i>This course includes:</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-2"><i class="fas fa-play-circle me-2 text-primary"></i> {{ course.duration }} of video</li>
                        <li class="mb-2"><i class="fas fa-file-alt me-2 text-primary"></i> {{ course.documents.count }} downloadable resources</li>
                        <li class="mb-2"><i class="fas fa-tasks me-2 text-primary"></i> {{ course.assignments.count }} assignments</li>
                        <li class="mb-2"><i class="fas fa-certificate me-2 text-primary"></i> Certificate of completion</li>
                        <li class="mb-2"><i class="fas fa-infinity me-2 text-primary"></i> Full lifetime access</li>
                    </ul>

                    {# Skills you'll gain #}
                    {% if course.skills_taught.all %}
                    <hr class="my-4">
                    <h6 class="fw-bold mb-3"><i class="fas fa-code me-2"></i>Skills you'll gain</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% for skill in course.skills_taught.all %}
                        <span class="skill-badge">{{ skill.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# Share #}
                    <hr class="my-4">
                    <h6 class="fw-bold mb-3">Share this course</h6>
                    <div>
                        <a href="https://twitter.com/intent/tweet?text={{ course.title }}&url={{ request.build_absolute_uri }}" 
                           target="_blank" class="share-btn"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                           target="_blank" class="share-btn"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" 
                           target="_blank" class="share-btn"><i class="fab fa-linkedin-in"></i></a>
                        <button class="share-btn" onclick="navigator.clipboard.writeText(window.location.href); alert('Link copied!');">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Call to Action #}
    <section class="bg-dark text-white text-center py-5 mt-5">
        <div class="container py-4">
            <div class="col-lg-8 mx-auto">
                <h2 class="display-6 fw-bold mb-4">Ready to start learning?</h2>
                <p class="lead mb-5">
                    Join {{ course.enrollment_count }} students already enrolled in this course.
                </p>
                {% if not is_enrolled %}
                    {% if course.slug %}
                    <form method="post" action="{% url 'enroll_course' course.slug %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5 py-3">
                            <i class="fas fa-graduation-cap me-2"></i>Enroll Now
                        </button>
                    </form>
                    {% endif %}
                {% else %}
                    {% if first_module %}
                    <a href="{% url 'course_module_detail' course.slug first_module.id %}" 
                       class="btn btn-success btn-lg rounded-pill px-5 py-3">
                        <i class="fas fa-play-circle me-2"></i>Continue Learning
                    </a>
                    {% else %}
                    <a href="{% url 'course_detail' course.slug %}" 
                       class="btn btn-outline-light btn-lg rounded-pill px-5 py-3">
                        <i class="fas fa-info-circle me-2"></i>Course Overview
                    </a>
                    {% endif %}
                {% endif %}
                <a href="{% url 'course_list' %}" class="btn btn-outline-light btn-lg rounded-pill px-5 py-3 ms-3">
                    <i class="fas fa-arrow-left me-2"></i>Browse All Courses
                </a>
            </div>
        </div>
    </section>
{% endblock %}